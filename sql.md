## SQL基本
- データベースとは、テキストや数値などのデータを保存するためのツール。”管理しやすいように整理されたデータ群のこと”
- https://udemy.benesse.co.jp/development/system/intro-sql.html#:~:text=SQL%E3%81%A8%E3%81%AF%E3%80%81%E3%80%8CStructured%20Query,%E3%81%99%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E8%A8%80%E8%AA%9E%E3%81%A7%E3%81%99%E3%80%82
- データベースは、左の図のような表でデータを管理している。表のことを「テーブル」、横の行のことを「レコード」と呼ぶ
- クエリとは、データベースに送る命令（クエリ）のこと
- SQL（Structured Query Language: 構造化問い合わせ言語）とはクエリを書くための言語。※コンピュータ言語のひとつだが、プログラミング言語ではない。

### 「SELECT」
- データを取得するために使用する。「どのカラムのデータを取得するか」を選択する
- 全カラムのデータを取得する場合は「＊」の記号を使用
- 複数のカラムからデータを取得する場合は、カラム名をコンマ（ , ）で区切る
  - 例: SELECT name, price
### 「FROM」
- データベースには複数のテーブルが存在する場合があるため、「FROM」を使用して、SELECTで選んだカラムが「どのテーブルのカラムか」を指定する必要がある
- ここまでがクエリです」ということをデータベースに伝えるためのセミコロン（；）を末尾に加える
### 「WHERE」
- 特定のデータを取得するためには、「どこの」という意味を持つ「WHERE」を使用。「WHERE」が意味するのは、「どこのレコード（横の行）を取得するか」
- データベースに保存されているデータには、「データ型」と呼ばれるルールがある。「データ型」とは、テキストデータや数値データ、さらには日付データといったように「データの種類」を示すもの
- テキストや日付はクォーテーションで囲む必要がある、数値は囲まない

### 「LIKE演算子」
- ”ある文字を含むデータ”を取得したい場合は、「〜のような」という意味を持つ、「LIKE演算子」を使用する。例のようにすることで「指定したカラムが◯◯を含む（〇〇のような）レコード」という条件となる
```
SELECT *
FROM purchases
WHERE name LIKE 文字列;
```
- 「ワイルドカード」⋯ LIKE演算子を用いる際に覚えておく必要があり。コンピュータの世界で「ワイルドカード」とは、どんな文字列にも一致することを指す記号。LIKE演算子では「％」をワイルドカードとして扱う。
```
SELECT *
FROM purchases
WHERE name LIKE "%プリン%";

例（下記に合致）
プリン
牛乳プリン
プリンパフェ
焼きプリン大福
```
- ワイルドカードを文字列の前後どちらかにのみ置くことも可能。「〇〇%」とした場合、「〇〇」以降はどんな文字列にも一致するので、「〇〇」で始まる文字列を検索することができる。このような検索を「前方一致」と呼ぶ。
- 「%〇〇」とした場合、「〇〇」より前はどんな文字列にも一致するので「〇〇」で終わる文字列を検索することができる。このような検索を「後方一致」と呼ぶ。
### 「NOT演算子」
- 「〇〇を含まないデータ」や「〇〇に一致しないデータ」のような条件でデータを取得したい場合は「否定」を意味する「NOT演算子」を使用する
### NULL
- 中身がなにか分からないということを示し、何のデータも保存されていない場合などにNULLとなる
- NULLのデータを取得するためには「〜がNULLである」という意味になる、「IS NULL」を用いる
```
SELECT * FROM purchases
WHERE price IS NULL;
```
### 「IS NOT NULL」
- 「NULLではないデータ」を取得する場合は「〜がNULLでない」という意味になる「IS NOT NULL」を使用する
### 「AND演算子」
- AND演算子を使うと、WHEREに複数の条件を指定することができる。「WHERE 条件１ AND 条件２」のようにすることで、条件１と条件２を共に満たすデータを検索することができる
### 「OR演算子」
- AND演算子と同様に、複数の条件を扱える。「WHERE 条件１ OR 条件２」のようにすることで、条件１または条件２のどちらかを満たすデータを検索することができる。
### 「ORDER BY」
- データを並び替えるためには、「〜順に並べる」という意味の「ORDER BY」を使用する。またデータを並び替えるためには、図のように「（基準となる）並べ替えたいカラム名」と「並べ方」を指定する。
```
ORDER BY 並べ替えたいカラム名　並べ方;
```
- 「ORDER BY」の並べ方は、「昇順」か「降順」を指定。「昇順」は「小さい数から大きい数へ向かう順序」、「降順」は「大きい数から小さい数へ向かう順序」
- SQLでは「昇順」は「ASC」、「降順」は「DESC」
- 「ORDER BY」はクエリの末尾に記述することで、取得結果を並び替える。
### 「LIMIT」
- 最大で何件取得するか」を指定するためには、「制限する」という意味の「LIMIT」を使用する。
- 「LIMIT」も「ORDER BY」と同様に「WHERE」と併用することが可能(ORDER BYと併用する場合は、LIMITを末尾に指定する）
## 実践的なSQL(検索結果の加工)
### 「DISTINCT」
- DISTINCTを使用すると、検索結果から重複するデータを除くことが可能。「DISTINCT(カラム名)」とすることで、検索結果から指定したカラムの重複するデータを除くことができる。
```
SELECT DISTINCT(name)
FROM purchases;
```
### SUM関数
- SQLで数値の合計を計算する場合は、SUMを使用する。SUM(カラム名) のようにすることで、指定したカラムに保存されたデータの合計を計算することが可能。
- SUM関数はSELECTで取得するカラムに用いることで、集計結果を取得することができる。
- SUM関数はWHEREと併用することができる。
### AVG関数
- SQLで数値の平均を計算する場合は、AVGを使用する。「AVG(カラム名)」のようにすることで、指定したカラムに保存されたデータの平均を計算することが可能。
- AVG関数はSELECTで取得するカラムに使用することで、計算結果を取得することができる。
### COUNT関数
- COUNT関数は、指定したカラムのデータの合計数を計算してくれる関数
- COUNT関数でカラム名を指定した場合、nullになっているデータの数は計算されない！！！
- nullの数も含めてデータの数を計算したい場合は、COUNT関数で * (全てのカラム)を指定する。* を使った場合、特定のカラムのデータの数ではなく、レコードの数を計算するので、nullの数を含めてデータの数を数えられる。
- COUNT関数はWHEREと併用することができる。
### MAX・MIN関数
- SQLでMAXという関数を用いると、指定したカラムのデータの中から最大のデータを取得することができる
- MINと言う関数を用いることで、最小のデータを取得することができる
- MAX,MINも他の集計関数と同様にSELECTで取得したカラムに使用することができる
- 他の集計関数と同様にWHEREと併用することができる
### GROUP BY
- GROUP BYを用いると、データをグループ化することができる。「GROUP BY カラム名」とすることで、指定したカラムで、完全に同一のデータを持つレコードどうしが同じグループとなる。
- グループ化するには、今までの集計関数を取得するFROMの後ろに「GROUP BY カラム名」を追加する
- GROUP BYを用いる場合、SELECTで使えるのは、GROUP BYに指定しているカラム名と、集計関数のみ！！！
```
SELECT SUM(price), purchased_at
FROM purchases
GROUOP BY purchased_at;
```
- GROUP BYは複数のカラム名を適用させることができ、その場合は、カラム名同士をコンマ(,)で繋げる。
```
GROUP BY カラム名1, カラム名2, ...
```
- GROUP BYはWHEREとも併用することができ、その場合はWHEREの後に書く（優先順位は、上から下の順で実行される）

| 取得条件 | WHERE |
| :---: | :--- |
| グループ化 | GROUP BY |
| 集計関数 | COUNT ・ SUM ・ AVG ・ MAX ・ MIN |

### 「HAVING」
- GROUP BYでグループ化したデータを更に絞り込みたい場合には、HAVINGを使用する
```
GROUP BY カラム名
HAVING 条件
```
- グループ化した後のデータを絞り込む際、WHEREではなくHAVINGを使うのは、SQLの各コマンドが以下の順番で実行されていくため。図のようにWHEREはまず最初に、そのあとにGROUP BYと関数が実行され、その後にHAVINGが実行される。

| 取得条件 | WHERE |
| :---: | :--- |
| グループ化 | GROUP BY |
| 集計関数 | COUNT・SUM・AVG・MAX・MIN |
| 絞り込み | HAVING |

## WHEREとHAVINGの違い
- 実行順序によって、WHEREとHAVINGは検索対象に違いがある。WHEREはグループ化される前のテーブル全体を検索対象とするのに対し、HAVINGはGROUP BYによってグループ化されたデータを検索対象とする。
## HAVINGの注意点
- HAVINGはグループ化された後のテーブルから検索するため、条件文で使うカラムは必ずグループ化されたテーブルのカラムを使う

## 高度な分析（サブクエリ）
### サブクエリ
- SQLでは、クエリの中に他のクエリを入れることができる。この他のクエリをサブクエリと言う。2つ以上のクエリを1つにまとめることができるので、より複雑なデータを取得する際に使われる。
- サブクエリの使用方法は、()で囲む。書き方は基本的に通常のクエリと同じだが、（）にセミコロンは不要。セミコロンはクエリの最後の文末のみでOK.
- 
```
サブクエリを含むクエリの場合、サブクエリが実行された後、外側にあるクエリが実行される。

SELECT name
FROM players
WHERE goals > (
  SELECT goals
  FROM players
  WHERE name = "sirotaro"
);
```
### 「AS」
- ASを使うことでカラム名などに別名を定義することができる
- 「カラム名 AS "名前"」で、カラム名に定義する名前を指定する
### 「JOIN」
- JOINは複数のテーブルを1つに結合したいときに使用する。ONで条件を指定して、テーブルAにテーブルBを結合する。結合したテーブルは1つのテーブルとしてデータを取得することができる。
#### 結合条件
- 「ON テーブル名.カラム名（外部キー） = テーブル名.カラム名（主キー）」で指定する
```
SELECT *
FROM テーブル名A
JOIN テーブル名B
ON テーブルA.カラム名 = テーブルB.カラム名
```
- JOINを含んだクエリでは、はじめにJOINが実行される。その次に、結合されたテーブルに対してSELECTが実行される。
#### 複数テーブルでのカラムの指定
- 複数のテーブルに同じカラム名が存在するときは、「テーブル名.カラム名」で指定しなければならない
- 「テーブル名.カラム名」を用いたカラム指定は、WHERE内でも使える。複数テーブルを扱うときは、異なるテーブルで同じカラム名が存在する場合があるので覚えておく必要あり。

| テーブル指定 | FROM |
| :---: | :--- |
| 結合 | ON・JOIN |
| 取得条件 | WHERE |
| グループ化 | GROUP BY |
| 集計関数 | COUNT・SUM・AVG・MAX・MIN |
| 絞り込み | HAVING |
| 検索 | SELECT・DISTINCT（重複避け） |
| 順序 | ORDER BY |
| 制限 | LIMIT |

#### NULLを含んだ場合の実行結果
- JOINを使った結合は、FROMで指定したテーブルを基準に実行されるが、外部キーがNULLのレコードは、実行結果に表示されない。

### 「LEFT JOIN」
- LEFT JOINを使うことで、FROMで指定したテーブルのレコードを全て取得できる。外部キーがNULLのレコードもNULLのまま実行結果に表示される。
#### 3つ以上のテーブル結合
- JOINは1つのクエリで、複数回使用できる。JOINを複数回使用しても、FROMは1度だけ書けばよいので注意。

